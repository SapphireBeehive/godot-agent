# nginx stream proxy for github.com
# Passes TCP/TLS traffic transparently to GitHub

# Log format for stream connections
log_format proxy_github '$remote_addr [$time_local] '
                        '$protocol $status $bytes_sent $bytes_received '
                        '$session_time "$upstream_addr"';

# Upstream definition with variable for DNS resolution
upstream github_upstream {
    server github.com:443;
}

upstream github_upstream_http {
    server github.com:80;
}

# TCP proxy for HTTPS (port 443)
server {
    listen 443;
    
    access_log /dev/stdout proxy_github;
    error_log /dev/stderr info;
    
    proxy_pass github_upstream;
    proxy_connect_timeout 10s;
    proxy_timeout 300s;
    proxy_socket_keepalive on;
}

# HTTP (port 80) - for redirects
server {
    listen 80;
    
    access_log /dev/stdout proxy_github;
    
    proxy_pass github_upstream_http;
    proxy_connect_timeout 10s;
    proxy_timeout 60s;
}
